# *ClickFix - conhost.exe headless and wmic product install remote source.md*

## Query Information

#### Changelog

| Date | Comments |
|---|---|
| 2025/05/24 | Initial version |

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1204.004 | User Execution: Malicious Copy and Paste | https://attack.mitre.org/techniques/T1204/004/ |
| T1047 | Windows Management Instrumentation | https://attack.mitre.org/techniques/T1047/ |
| T1202 | Indirect Command Execution | https://attack.mitre.org/techniques/T1202/ |

#### Description

Taken from a ClickFix commandline observed on May 24, 2025. It is worth nothing this commandline was correctly flagged as ClickFix by Defender for Endpoint (MDE) and blocked.

These queries look for:

- Processes that are spawned by a conhost.exe process launched with the --headless argument
- wmic.exe calling "product install" where the install source (package) is hosted remotely (on the Internet)

### References ###

- https://x.com/SecurityAura/status/1926447337926267238
- https://lolbas-project.github.io/lolbas/Binaries/Conhost/

### Queries Overview ###

- Defender for Endpoint (MDE) - 2 queries

## Defender XDR ##
### Query 1 - Defender for Endpoint (MDE) via DeviceProcessEvents ###
```KQL
DeviceProcessEvents
| where InitiatingProcessFileName =~ "conhost.exe" 
| where InitiatingProcessCommandLine has "--headless"
```
### Query 2 - Defender for Endpoint (MDE) via DeviceProcessEvents ###
```KQL
DeviceProcessEvents
| where FileName =~ "wmic.exe"
| where ProcessCommandLine has_all ("product", "call", "install")
| where ProcessCommandLine has_any ("http", "https")
```
## Microsoft Sentinel ##
### Query 1 - Defender for Endpoint (MDE) via DeviceLogonEvents ###
```KQL
DeviceProcessEvents
| where InitiatingProcessFileName =~ "conhost.exe" 
| where InitiatingProcessCommandLine has "--headless"
```
### Query 2 - Defender for Identity (MDI) via IdentityLogonEvents ###
```KQL
DeviceProcessEvents
| where FileName =~ "wmic.exe"
| where ProcessCommandLine has_all ("product", "call", "install")
| where ProcessCommandLine has_any ("http", "https")
```
