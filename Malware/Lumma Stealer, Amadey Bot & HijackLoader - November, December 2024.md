# *Lumma Stealer, Amadey Bot & HijackLoader - November, December 2024.md*

## Query Information

Multiple queries to detect some TTPs and behavior of a campaign which delivers Lumma Stealer, Amadey Bot and HijackLoader.
First spotted in November 2024.

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1566 | Phishing | https://attack.mitre.org/techniques/T1566/ |
| T1204.002 | User Execution: Malicious File | https://attack.mitre.org/techniques/T1204/002/ |
| T1197 | BITS Jobs | https://attack.mitre.org/techniques/T1197/ |
| T1547.001 | Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder | https://attack.mitre.org/techniques/T1547/001/ |
| T1218 | System Binary Proxy Execution | https://attack.mitre.org/techniques/T1218/ |

#### Description

An endpoint was compromised as part of this campaign. Lumma Stealer, Amadey Bot and HijackLoader may be present on the endpoint.

#### Risk

A user just executed an Amadey payload (e.g.: .pdf.lnk file)

#### Author <Optional>
- **Name:** SecurityAura
- **Github:** https://github.com/SecurityAura
- **Twitter:** https://x.com/SecurityAura
- **LinkedIn:** Coming Soon!
- **Website:** https://medium.com/@securityaura

#### References
- https://cyble.com/blog/threat-actor-targets-manufacturing-industry-with-malware/

## Defender XDR
### DeviceProcessEvents - ssh.exe ProxyCommand
```KQL
DeviceProcessEvents
| where FileName =~ "ssh.exe"
| where ProcessCommandLine has "ProxyCommand"
```

### DeviceNetworkEvents - svchost.exe WebClient or explorer.exe network connection to .shop domain
```KQL
DeviceNetworkEvents
| where (InitiatingProcessFileName =~ "svchost.exe" and InitiatingProcessCommandLine has "WebClient")
    or InitiatingProcessFileName =~ "explorer.exe"
| where RemoteUrl has ".shop"
```

### DeviceNetworkEvents - mshta.exe with URL in command line network connection
```KQL
DeviceNetworkEvents
| where InitiatingProcessFileName =~ "mshta.exe"
| where InitiatingProcessCommandLine has_any ("http","https")
```

### DeviceNetworkEvents - Network Connection to a URL with .pdf.lnk
```KQL
DeviceNetworkEvents
| where RemoteUrl has ".pdf.lnk"
```

### DeviceFileEvents - LNK file created in temporay TfsStore\Tfs_DAV folder
```KQL
DeviceFileEvents
| where FolderPath has "\\Windows\\ServiceProfiles\\LocalService\\AppData\\Local\\Temp\\TfsStore\\Tfs_DAV\\"
| where FileName endswith ".lnk"
```

### DeviceEvents - SetThreatContextRemoteApiCall targeting more.com
```KQL
DeviceEvents
| where ActionType == "SetThreadContextRemoteApiCall"
| where FileName =~ "more.com"
```

### DeviceEvents - svchost.exe BITS creating a new LNK in the Startup folder
```KQL
DeviceEvents
| where ActionType == "ShellLinkCreateFileEvent"
| where InitiatingProcessFileName =~ "svchost.exe"
| where InitiatingProcessCommandLine has "BITS"
| where FolderPath has "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"
```

## Microsoft Sentinel
### DeviceProcessEvents - ssh.exe ProxyCommand
```KQL
DeviceProcessEvents
| where FileName =~ "ssh.exe"
| where ProcessCommandLine has "ProxyCommand"
```

### DeviceNetworkEvents - svchost.exe WebClient or explorer.exe network connection to .shop domain
```KQL
DeviceNetworkEvents
| where (InitiatingProcessFileName =~ "svchost.exe" and InitiatingProcessCommandLine has "WebClient")
    or InitiatingProcessFileName =~ "explorer.exe"
| where RemoteUrl has ".shop"
```

### DeviceNetworkEvents - mshta.exe with URL in command line network connection
```KQL
DeviceNetworkEvents
| where InitiatingProcessFileName =~ "mshta.exe"
| where InitiatingProcessCommandLine has_any ("http","https")
```

### DeviceNetworkEvents - Network Connection to a URL with .pdf.lnk
```KQL
DeviceNetworkEvents
| where RemoteUrl has ".pdf.lnk"
```

### DeviceFileEvents - LNK file created in temporay TfsStore\Tfs_DAV folder
```KQL
DeviceFileEvents
| where FolderPath has "\\Windows\\ServiceProfiles\\LocalService\\AppData\\Local\\Temp\\TfsStore\\Tfs_DAV\\"
| where FileName endswith ".lnk"
```

### DeviceEvents - SetThreatContextRemoteApiCall targeting more.com
```KQL
DeviceEvents
| where ActionType == "SetThreadContextRemoteApiCall"
| where FileName =~ "more.com"
```

### DeviceEvents - svchost.exe BITS creating a new LNK in the Startup folder
```KQL
DeviceEvents
| where ActionType == "ShellLinkCreateFileEvent"
| where InitiatingProcessFileName =~ "svchost.exe"
| where InitiatingProcessCommandLine has "BITS"
| where FolderPath has "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"
```
