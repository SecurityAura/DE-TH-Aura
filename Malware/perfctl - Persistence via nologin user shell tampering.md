# *perfctl - Persistence via nologin user shell tampering*

## Query Information

These queries looks for two (2) of the four (4) steps used by perfctl's attackers to set up persistence on a compromised Linux system.

#### Description

As reported in ExaTrack's blog post on Perfctl (https://blog.exatrack.com/Perfctl-using-portainer-and-new-persistences/), the attacker set up persistence by performing the following steps (copy/pasted from ExaTrack's blog post):

- Create /var/spool/news/.ssh/authorized_keys containing the attacker public-key
- Make a copy of /bin/dash as /usr/sbin/nologin (with a trailing space)
- Modify /etc/shells to include nologin (with a trailing space)
- Add a space at the end of news line in /etc/passwd

Based on Defender for Endpoint (MDE) telemetry, it should be possible to detect the first two (2) steps.

- Find the creation of an authorized_keys file under a "built-in" Linux user profile
- Find the creation of a file named nologin with a trailing space

For the 1nd one, we can declare a variable that holds a dynamic list of "built-in" Linux users. You can gather this from whichever source you like.

The 2nd one could be made more generic in which, on Linux systems, you could look for any file events involving a file with a trailing space at the end.

An additional query could then be created for the follow-up step which is, a SSH session opened by a "built-in" Linux user.

#### Author
- **Name:** SecurityAura
- **Github:** https://github.com/SecurityAura
- **Twitter:** https://x.com/SecurityAura
- **LinkedIn:** Coming Soon!
- **Website:** https://medium.com/@securityaura

#### References

- https://blog.exatrack.com/Perfctl-using-portainer-and-new-persistences/ (Original blog post)
- https://x.com/RFGroenewoud/status/1875112050218922010 (Tweet that inspired me to write these queries)

### Queries Overview ###

- Defender for Endpoint (MDE) - 3 queries

## Defender XDR ##
### Query #1 - Defender for Endpoint (MDE) via DeviceFileEvents - authorized_keys file creation under built-in Linux user profile ###
```KQL
// For my list, I decided to grab the users from Ruben's screenshot in his tweet (see the References section below)
let BuiltinLinuxUsers = dynamic([
    "deamon",
    "bin",
    "sys",
    "games",
    "man",
    "lp",
    "mail",
    "news",
    "uucp",
    "proxy",
    "www-data",
    "backup",
    "list",
    "irc",
    "gnats",
    "nobody"
]);
// There's more likely a better way to do this by setting up in the var the association of user + user profile path. This is just me being lazy.
DeviceFileEvents
| where FolderPath has_any (BuiltinLinuxUsers)
| where FileName =~ "authorized_keys"
```
### Query #2 - Defender for Endpoint (MDE) via DeviceFileEvents - nologin (with a trailing space) file creation ###
```KQL
DeviceFileEvents
| where FileName =~ "nologin "

// You can honestly even take this one step further and look for ANY file events involving a file with a trailing space at the end.
DeviceFileEvents
| where FileName endswith " "

// And if you want to only target Linux systems, build your list from DeviceInfo beforehand
let LinuxDevices = (
    DeviceInfo
    | where OSPlatform == "Linux"
    | distinct DeviceName);
DeviceFileEvents
| where DeviceName in (LinuxDevices)
| where FileName endswith " "
```
### Query #3 - Defender for Endpoint (MDE) via DeviceLogonEvents - Logon from built-in "nologin" Linux user ###
```KQL
// For my list, I decided to grab the users from Ruben's screenshot in his tweet (see the References section below)
let BuiltinLinuxUsers = dynamic([
    "deamon",
    "bin",
    "sys",
    "games",
    "man",
    "lp",
    "mail",
    "news",
    "uucp",
    "proxy",
    "www-data",
    "backup",
    "list",
    "irc",
    "gnats",
    "nobody"
]);
DeviceLogonEvents
| where AccountName in~ (BuiltinLinuxUsers)
```
## Microsoft Sentinel ##
### Query #1 - Defender for Endpoint (MDE) via DeviceFileEvents - authorized_keys file creation under built-in Linux user profile ###
```KQL
// For my list, I decided to grab the users from Ruben's screenshot in his tweet (see the References section below)
let BuiltinLinuxUsers = dynamic([
    "deamon",
    "bin",
    "sys",
    "games",
    "man",
    "lp",
    "mail",
    "news",
    "uucp",
    "proxy",
    "www-data",
    "backup",
    "list",
    "irc",
    "gnats",
    "nobody"
]);
// There's more likely a better way to do this by setting up in the var the association of user + user profile path. This is just me being lazy.
DeviceFileEvents
| where FolderPath has_any (BuiltinLinuxUsers)
| where FileName =~ "authorized_keys"
```
### Query #2 - Defender for Endpoint (MDE) via DeviceFileEvents - nologin (with a trailing space) file creation ###
```KQL
DeviceFileEvents
| where FileName =~ "nologin "

// You can honestly even take this one step further and look for ANY file events involving a file with a trailing space at the end.
DeviceFileEvents
| where FileName endswith " "

// And if you want to only target Linux systems, build your list from DeviceInfo beforehand
let LinuxDevices = (
    DeviceInfo
    | where OSPlatform == "Linux"
    | distinct DeviceName);
DeviceFileEvents
| where DeviceName in (LinuxDevices)
| where FileName endswith " "
```
### Query #3 - Defender for Endpoint (MDE) via DeviceLogonEvents - Logon from built-in "nologin" Linux user ###
```KQL
// For my list, I decided to grab the users from Ruben's screenshot in his tweet (see the References section below)
let BuiltinLinuxUsers = dynamic([
    "deamon",
    "bin",
    "sys",
    "games",
    "man",
    "lp",
    "mail",
    "news",
    "uucp",
    "proxy",
    "www-data",
    "backup",
    "list",
    "irc",
    "gnats",
    "nobody"
]);
DeviceLogonEvents
| where AccountName in~ (BuiltinLinuxUsers)
```
